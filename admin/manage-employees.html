<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Employee Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <script>
    const token = localStorage.getItem("authToken");
    const role = localStorage.getItem("employeeRole");

    if (!token || role !== "ADMIN") {
      alert("Access denied");
      window.location.href = "index.html";
    }
  </script>
</head>

<body class="p-4 bg-light">

  <h3 class="mb-4">üë®‚Äçüíº Employee Management</h3>

  <table class="table table-bordered table-hover bg-white">
    <thead class="table-dark">
      <tr>
        <th>Emp Code</th>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="employeeTable"></tbody>
  </table>

  <!-- EDIT MODAL -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5>Edit Employee</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="empId">

          <input class="form-control mb-2" id="empName" placeholder="Name">
          <input class="form-control mb-2" id="empEmail" placeholder="Email">
          <input class="form-control mb-2" id="empPassword" placeholder="New Password">
          
          <select class="form-control mb-2" id="empRole">
            <option value="EMPLOYEE">EMPLOYEE</option>
            <option value="ADMIN">ADMIN</option>
          </select>

          <select class="form-control mb-2" id="empStatus">
            <option value="true">Active</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary" onclick="updateEmployee()">Update</button>
          <button class="btn btn-danger" onclick="deleteEmployee()">Delete</button>
        </div>
      </div>
    </div>
  </div>

<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
async function loadEmployees() {
  const res = await fetch(`${API_BASE_URL}/api/admin/employees`, {
    headers: { Authorization: "Bearer " + token }
  });

  const result = await res.json();
  if (!res.ok || !result.success) {
    alert("Failed to load employees");
    return;
  }

  const tbody = document.getElementById("employeeTable");
  tbody.innerHTML = "";

  result.data.forEach(emp => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${emp.employee_code}</td>
      <td>${emp.name}</td>
      <td>${emp.email}</td>
      <td>${emp.role}</td>
      <td>${emp.active ? "Active" : "Disabled"}</td>
      <td>
        <button class="btn btn-sm btn-primary edit-btn">
          <i class="bi bi-pencil"></i>
        </button>
      </td>
    `;

    tr.querySelector(".edit-btn").onclick = () => openEdit(emp);
    tbody.appendChild(tr);
  });
}

function openEdit(emp) {
  empId.value = emp.id;
  empName.value = emp.name;
  empEmail.value = emp.email;
  empRole.value = emp.role;
  empStatus.value = emp.active;

  new bootstrap.Modal(editModal).show();
}

async function updateEmployee() {
  const payload = {
    id: empId.value,
    name: empName.value,
    email: empEmail.value,
    role: empRole.value,
    is_active: empStatus.value === "true"
  };

  if (empPassword.value) {
    payload.password = empPassword.value;
  }

  const res = await fetch(`${API_BASE_URL}/api/admin/update-employee`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  if (!res.ok || !result.success) {
    alert(result.message || "Update failed");
    return;
  }

  bootstrap.Modal.getInstance(editModal).hide();
  loadEmployees();
}

async function deleteEmployee() {
  if (!confirm("Are you sure you want to delete this employee?")) return;

  const res = await fetch(`${API_BASE_URL}/api/admin/delete-employee`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ id: empId.value })
  });

  const result = await res.json();
  if (!res.ok || !result.success) {
    alert(result.message || "Delete failed");
    return;
  }

  bootstrap.Modal.getInstance(editModal).hide();
  loadEmployees();
}

loadEmployees();
</script>


</body>
</html>
